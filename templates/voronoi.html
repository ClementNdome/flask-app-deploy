<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>School Coverage Areas - Schools</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { margin:0; font-family:Inter, Arial }
      .page-header { background:#004d40; color:#fff; padding:10px 16px }
      #map { height: calc(100vh - 140px); }
      .controls { padding:8px }
      .legend { position:absolute; bottom:30px; right:10px; background:#fff; padding:10px; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.12) }
      .color-box { display:inline-block; width:20px; height:20px; margin-right:8px; border:1px solid #ccc }
      @media (max-width:767px){ #map { height:50vh } .controls { padding:10px } }
    </style>
  </head>
  <body>
    <div class="page-header d-flex justify-content-between align-items-center">
      <div><strong>School Coverage Areas (Voronoi)</strong></div>
      <div><a class="btn btn-sm btn-outline-light" href="{{ url_for('index') }}">Back</a></div>
    </div>
    <div class="container-fluid py-2">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-8">
          <div id="map"></div>
        </div>
        <div class="col-12 col-md-4">
          <div class="controls p-3 bg-light rounded">
            <div class="mb-2">Analysis radius (km): <input id="radius" class="form-control d-inline-block" value="10" style="width:110px;margin-left:8px"></div>
            <button class="btn btn-primary btn-sm" onclick="updateVoronoi()">Update</button>
          </div>
        </div>
      </div>
    </div>
    <div class="legend" id="vorLegend" aria-hidden="false" style="min-width:180px;">
      <div class="d-flex justify-content-between align-items-center">
        <strong>Coverage</strong>
        <button id="vorLegendToggle" class="btn btn-sm btn-outline-secondary" aria-expanded="true" aria-controls="vorLegendBody">Hide</button>
      </div>
      <div id="vorLegendBody" class="mt-2">
        <div class="d-flex align-items-center mb-1">
          <span class="color-box" style="background:#004d40"></span>
          <span>Service Area</span>
        </div>
        <div class="d-flex align-items-center mb-1">
          <span class="color-box" style="background:#b2dfdb"></span>
          <span>Buffer Zone</span>
        </div>
        <div class="small text-muted">Tip: increase radius to expand service area</div>
      </div>
    </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const center = {{ center|tojson }};
      const zoom = {{ zoom|tojson }};
      const map = L.map('map').setView(center, zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

      const layer = L.layerGroup().addTo(map);
      
      async function updateVoronoi() {
        const radius = document.getElementById('radius').value || '10';
        try {
          const res = await fetch(`{{ url_for('schools_voronoi') }}?radius_km=${radius}`);
          const data = await res.json();
          layer.clearLayers();
          
          // Add voronoi polygons
          L.geoJSON(data.voronoi, {
            style: {
              fillColor: '#004d40',
              color: '#00796b',
              weight: 1,
              fillOpacity: 0.2
            }
          }).addTo(layer);

          // Add buffer zones if present
          if (data.buffer) {
            L.geoJSON(data.buffer, {
              style: {
                fillColor: '#b2dfdb',
                color: '#80cbc4',
                weight: 1,
                fillOpacity: 0.1
              }
            }).addTo(layer);
          }

          // Add school points
          L.geoJSON(data.points, {
            pointToLayer: (f,latlng) => L.circleMarker(latlng, {
              radius: 6,
              fillColor: '#004d40',
              color: '#fff',
              weight: 2,
              opacity: 1,
              fillOpacity: 0.8
            }).bindPopup(f.properties.name || f.properties.NAME || 'School')
          }).addTo(layer);

        } catch(err) {
          console.error(err);
          alert('Error generating coverage areas');
        }
      }

      // Initial load
      updateVoronoi();

      // legend toggle for voronoi page
      document.getElementById('vorLegendToggle').addEventListener('click', function(){
        const btn = this; const body = document.getElementById('vorLegendBody');
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        if (expanded) { body.style.display = 'none'; btn.textContent = 'Show'; btn.setAttribute('aria-expanded','false'); }
        else { body.style.display = ''; btn.textContent = 'Hide'; btn.setAttribute('aria-expanded','true'); }
      });
    </script>
  </body>
</html>