<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Nearest Search - Schools</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{margin:0;font-family:Inter, Arial}#map{height:calc(100vh - 120px)}@media(max-width:767px){#map{height:55vh}}</style>
  </head>
  <body>
    <div class="d-flex justify-content-between align-items-center" style="background:#004d40;color:#fff;padding:10px">
      <div><strong>Nearest search</strong></div>
      <div><a class="btn btn-sm btn-outline-light" href="{{ url_for('index') }}">Back</a></div>
    </div>
    <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const center = {{ center|tojson }};
      const zoom = {{ zoom|tojson }};
      const map = L.map('map').setView(center, zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

      const markers = L.layerGroup().addTo(map);

      map.on('click', async function(e){
        const {lat,lng}=e.latlng;
        const k = prompt('Number of nearest features to retrieve (k):', '5') || '5';
        try{
          const url = `{{ url_for('get_schools') }}?lon=${lng}&lat=${lat}&k=${k}`;
          const res = await fetch(url);
          const data = await res.json();
          markers.clearLayers();
          L.geoJSON(data, {onEachFeature:(f,layer)=>layer.bindPopup(f.properties.name||f.properties.NAME||'School')}).addTo(markers);
          map.panTo(e.latlng);
        }catch(err){console.error(err);alert('Error fetching nearest features')}
      });

    </script>
  </body>
</html>
